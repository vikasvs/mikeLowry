{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            overflow: hidden; /* Prevent scrollbars */
        }
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%; /* Full height */
            box-sizing: border-box;
        }
        .tab-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.5); /* Translucent background */
            height: 100%; /* Full height */
            z-index: 1; /* Ensure it is above the plot */
        }
        .tab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            padding: 15px;
            font-size: 1em;
            color: #000;
            background-color: rgba(255, 255, 255, 0.5); /* Translucent background */
            border: none; /* No distinct border */
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            box-sizing: border-box;
        }
        .tab:hover {
            background-color: rgba(255, 255, 255, 0.7); /* Lighter translucent background */
            color: #e67e22; /* Change color on hover */
        }
        .tab.active {
            background-color: rgba(255, 255, 255, 0.7); /* Lighter translucent background */
            color: #e67e22; /* Change color on active */
        }
        .plot-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%; /* Use remaining height */
            padding: 0;
            background-color: #fff;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbars */
            position: relative; /* For z-index control */
            z-index: 0; /* Ensure it is below the tab-container */
        }
        .bottom-button-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            width: 100px;
            margin-top: auto;
            box-sizing: border-box;
        }
        .bottom-button-container button {
            width: 100%;
            padding: 10px;
            font-size: 0.9em;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.3s, color 0.3s;
            border-radius: 0;
            box-sizing: border-box;
        }
        .bottom-button-container button:hover {
            color: #e67e22;
            border-color: #e67e22;
            background-color: #fff;
        }
        .bottom-button-container button.active {
            color: #e67e22;
            border-color: #e67e22;
            background-color: #fff;
        }
        .info-box {
            display: none; /* Hide the info box */
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="tab-container">
            <div class="tab active" onclick="switchYear('master')">Master</div>
            <div class="tab" onclick="switchYear('2014')">2014</div>
            <div class="tab" onclick="switchYear('2016')">2016</div>
            <div class="tab" onclick="switchYear('2023')">2023</div>
            <div class="bottom-button-container">
                <button type="button" onclick="showTimeframe('3_Months')">3M</button>
                <button type="button" class="active" onclick="showTimeframe('1_Year')">1Y</button>
                <button type="button" onclick="showTimeframe('5_Years')">5Y</button>
            </div>
        </div>
        <div class="plot-container" id="plot-container">
            <!-- Plotly plot will be rendered here -->
        </div>
    </div>

    <script>
        console.log("JavaScript loaded");

        let lastYear = 'master';
        let currentTimeframe = '1_Year';

        function updateInfoBox() {
            // Info box is hidden, no need to update it
        }

        function fetchAndRenderPlotlyChart(year, timeframe) {
            console.log("Fetching and rendering Plotly chart for: " + year + " " + timeframe);
            const jsonUrl = "{% static '' %}" + year + '_' + timeframe + '_plotly.json';
            console.log("JSON URL: " + jsonUrl);

            fetch(jsonUrl)
                .then(response => {
                    console.log("Fetch response status: " + response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Data received: ", data);

                    if (!data.date || !data.close || !data.inflection_points) {
                        throw new Error('Invalid data format');
                    }

                    const trace1 = {
                        x: data.date,
                        y: data.close,
                        mode: 'lines',
                        name: 'SPY',
                        line: { color: 'black' }
                    };

                    const buySignals = {
                        x: data.inflection_points.filter(point => point.signal === 'Buy').map(point => point.date),
                        y: data.inflection_points.filter(point => point.signal === 'Buy').map(point => data.close[data.date.indexOf(point.date)]),
                        mode: 'markers',
                        marker: { color: 'green', size: 10 },
                        name: 'Buy'
                    };

                    const sellSignals = {
                        x: data.inflection_points.filter(point => point.signal === 'Sell').map(point => point.date),
                        y: data.inflection_points.filter(point => point.signal === 'Sell').map(point => data.close[data.date.indexOf(point.date)]),
                        mode: 'markers',
                        marker: { color: 'red', size: 10 },
                        name: 'Sell'
                    };

                    console.log("Buy signals: ", buySignals);
                    console.log("Sell signals: ", sellSignals);

                    // Adjust y-axis range to add space above and below
                    const yRange = [Math.min(...data.close) * 0.95, Math.max(...data.close) * 1.05];

                    const layout = {
                        title: `${year} ${timeframe.replace('_', ' ')}`,
                        xaxis: {
                            title: 'Date',
                            range: data.layout.xaxis.range,
                            showgrid: false // Remove grid lines
                        },
                        yaxis: {
                            title: 'Close Price',
                            range: yRange,
                            showgrid: false, // Remove grid lines
                            side: 'right', // Position y-axis on the right
                            overlaying: 'free', // Ensure the y-axis is not under anything
                            position: 1.05 // Move the y-axis further to the right
                        },
                        margin: {
                            t: 60, // Increase top margin for title
                            r: 200, // Increase right margin for better y-axis visibility
                            b: 60, // Add margin to the bottom to avoid overcrowding
                            l: 0 // Remove left margin to integrate with tabs
                        },
                        dragmode: 'zoom', // Enable zoom mode
                        hovermode: 'x unified', // Show vertical line and hover information
                        shapes: [
                            {
                                type: 'line',
                                xref: 'x',
                                yref: 'paper',
                                x0: 0,
                                y0: 0,
                                x1: 0,
                                y1: 1,
                                line: {
                                    color: 'gray',
                                    width: 1,
                                    dash: 'dot'
                                }
                            }
                        ]
                    };

                    const plotData = [trace1, buySignals, sellSignals];

                    Plotly.newPlot('plot-container', plotData, layout);

                    const plotDiv = document.getElementById('plot-container');

                    plotDiv.on('plotly_hover', function(data) {
                        var infotext = data.points.map(function(d) {
                            return (d.data.name + ': x= ' + d.x + ', y= ' + d.y.toPrecision(3));
                        });

                        Plotly.Fx.hover(plotDiv, [
                            {
                                curveNumber: data.points[0].curveNumber,
                                pointNumber: data.points[0].pointNumber
                            }
                        ]);

                        // Update the hover point
                        Plotly.Fx.loneHover({
                            xval: data.points[0].x,
                            yval: data.points[0].y,
                            name: data.points[0].data.name,
                            hovermode: 'closest',
                            axis: plotDiv.layout.xaxis
                        });
                    });

                    plotDiv.on('plotly_unhover', function() {
                        Plotly.Fx.loneUnhover(plotDiv);
                    });

                    plotDiv.on('plotly_click', function(data) {
                        var infotext = data.points.map(function(d) {
                            return (d.data.name + ': x= ' + d.x + ', y= ' + d.y.toPrecision(3));
                        });

                        Plotly.Fx.hover(plotDiv, [
                            {
                                curveNumber: data.points[0].curveNumber,
                                pointNumber: data.points[0].pointNumber
                            }
                        ]);

                        // Update the hover point
                        Plotly.Fx.loneHover({
                            xval: data.points[0].x,
                            yval: data.points[0].y,
                            name: data.points[0].data.name,
                            hovermode: 'closest',
                            axis: plotDiv.layout.xaxis
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching JSON data:', error);
                });
        }

        function showTimeframe(timeframe) {
            currentTimeframe = timeframe;
            console.log("Switching timeframe to: " + timeframe);
            document.querySelectorAll('.bottom-button-container button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.bottom-button-container button[onclick="showTimeframe('${timeframe}')"]`).classList.add('active');
            fetchAndRenderPlotlyChart(lastYear, currentTimeframe);
        }

        function switchYear(year) {
            lastYear = year;
            console.log("Switching year to: " + year);
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="switchYear('${year}')"]`).classList.add('active');
            fetchAndRenderPlotlyChart(lastYear, currentTimeframe);
        }

        window.onload = function() {
            console.log("Window loaded");
            fetchAndRenderPlotlyChart('master', '1_Year');
        }

        // Resize Plotly chart when window is resized
        window.onresize = function() {
            Plotly.Plots.resize(document.getElementById('plot-container'));
        }
    </script>
</body>
</html>
