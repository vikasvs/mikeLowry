{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            overflow: hidden; /* Prevent scrollbars */
        }
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%; /* Full height */
            box-sizing: border-box;
        }
        .tab-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.5); /* Translucent background */
            height: 100%; /* Full height */
            z-index: 1; /* Ensure it is above the plot */
        }
        .tab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            padding: 15px;
            font-size: 1em;
            color: #000;
            background-color: rgba(255, 255, 255, 0.5); /* Translucent background */
            border: none; /* No distinct border */
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            box-sizing: border-box;
        }
        .tab:hover {
            background-color: rgba(255, 255, 255, 0.7); /* Lighter translucent background */
            color: #e67e22; /* Change color on hover */
        }
        .tab.active {
            background-color: rgba(255, 255, 255, 0.7); /* Lighter translucent background */
            color: #e67e22; /* Change color on active */
        }
        .plot-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%; /* Use remaining height */
            padding: 0;
            background-color: #fff;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbars */
            position: relative; /* For z-index control */
            z-index: 0; /* Ensure it is below the tab-container */
        }
        .bottom-button-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            width: 100px;
            margin-top: auto;
            box-sizing: border-box;
        }
        .bottom-button-container button {
            width: 100%;
            padding: 10px;
            font-size: 0.9em;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.3s, color 0.3s;
            border-radius: 0;
            box-sizing: border-box;
        }
        .bottom-button-container button:hover {
            color: #e67e22;
            border-color: #e67e22;
            background-color: #fff;
        }
        .bottom-button-container button.active {
            color: #e67e22;
            border-color: #e67e22;
            background-color: #fff.
        }
        .info-box {
            display: none; /* Hide the info box */
        }
        .custom-tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #dcdcdc;
            padding: 5px;
            font-size: 12px;
            color: #333;
            z-index: 10;
            display: none; /* Hidden by default */
        }
        .hover-line {
            position: absolute;
            width: 1px;
            background: black;
            display: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="tab-container">
            <div class="tab" oncontextmenu="handleRightClick(event, '2014')" onclick="handleTabClick('2014')">2014</div>
            <div class="tab" oncontextmenu="handleRightClick(event, '2016')" onclick="handleTabClick('2016')">2016</div>
            <div class="tab" oncontextmenu="handleRightClick(event, '2023')" onclick="handleTabClick('2023')">2023</div>
            <div class="bottom-button-container">
                <button type="button" onclick="showTimeframe('3_Months')">3M</button>
                <button type="button" class="active" onclick="showTimeframe('1_Year')">1Y</button>
                <button type="button" onclick="showTimeframe('5_Years')">5Y</button>
            </div>
        </div>
        <div class="plot-container" id="plot-container">
            <!-- Plotly plot will be rendered here -->
            <div class="custom-tooltip" id="tooltip"></div>
            <div class="hover-line" id="hover-line"></div>
        </div>
    </div>

    <script>
        console.log("JavaScript loaded");

        let selectedYears = [];
        let currentTimeframe = '1_Year';

        const timeframes = {
            '3_Months': 3 * 30 * 24 * 60 * 60 * 1000,
            '1_Year': 365 * 24 * 60 * 60 * 1000,
            '5_Years': 5 * 365 * 24 * 60 * 60 * 1000
        };

        const markerSizes = {
            '3_Months': 12,
            '1_Year': 9,
            '5_Years': 7
        };

        function updateInfoBox() {
            // Info box is hidden, no need to update it
        }

        function fetchAndRenderPlotlyChart(years, timeframe) {
            console.log("Fetching and rendering Plotly chart for: " + years + " " + timeframe);
            const jsonUrls = years.map(year => "{% static '' %}" + year + '_5_Years_plotly.json');
            console.log("JSON URLs: " + jsonUrls);

            Promise.all(jsonUrls.map(url => fetch(url).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })))
            .then(datasets => {
                const plotData = [];
                let xMin = Infinity;
                let xMax = -Infinity;
                let allYValues = [];

                datasets.forEach((data, index) => {
                    if (!data.date || !data.close || !data.inflection_points) {
                        throw new Error('Invalid data format');
                    }

                    const dates = data.date.map(date => new Date(date));
                    xMin = Math.min(xMin, ...dates);
                    xMax = Math.max(xMax, ...dates);

                    const trace = {
                        x: dates,
                        y: data.close,
                        mode: 'lines',
                        name: years[index],
                        line: { color: 'black', width: 2 }, // Keep plots black
                        opacity: 0.6, // Make plot lines slightly transparent
                        hoverinfo: 'none' // Disable hover info for lines
                    };

                    const buySignals = {
                        x: data.inflection_points.filter(point => point.signal === 'Buy').map(point => new Date(point.date)),
                        y: data.inflection_points.filter(point => point.signal === 'Buy').map(point => data.close[data.date.indexOf(point.date)]),
                        mode: 'markers',
                        marker: { color: 'green', size: markerSizes[timeframe], symbol: 'circle', line: { width: 2, color: 'black' } },
                        name: 'Buy',
                        textposition: 'top',
                        hoverinfo: 'none' // Hide hover info for individual points
                    };

                    const sellSignals = {
                        x: data.inflection_points.filter(point => point.signal === 'Sell').map(point => new Date(point.date)),
                        y: data.inflection_points.filter(point => point.signal === 'Sell').map(point => data.close[data.date.indexOf(point.date)]),
                        mode: 'markers',
                        marker: { color: 'red', size: markerSizes[timeframe], symbol: 'circle', line: { width: 2, color: 'black' } },
                        name: 'Sell',
                        textposition: 'top',
                        hoverinfo: 'none' // Hide hover info for individual points
                    };

                    allYValues = allYValues.concat(data.close);
                    plotData.push(trace, buySignals, sellSignals);
                });

                const selectedXRange = [new Date(xMax - timeframes[timeframe]), new Date(xMax)];
                const visibleYValues = plotData.flatMap(trace => trace.y).filter((_, i) => plotData[0].x[i] >= selectedXRange[0]);
                const yRange = [
                    Math.min(...visibleYValues) * 0.95,
                    Math.max(...visibleYValues) * 1.05
                ];

                const layout = {
                    title: `${years.join(', ')} ${timeframe.replace('_', ' ')}`,
                    xaxis: {
                        range: selectedXRange,
                        showgrid: true, // Show grid lines
                        zeroline: true, // Show x-axis
                        zerolinewidth: 2, // Width of the x-axis
                        tickvals: plotData[0].x.filter((_, i) => i % Math.floor(plotData[0].x.length / 10) === 0 && i !== 0), // Reduce number of ticks and avoid the first tick
                        ticktext: plotData[0].x.filter((_, i) => i % Math.floor(plotData[0].x.length / 10) === 0 && i !== 0).map(d => d.toLocaleDateString()), // Format tick text
                        tickangle: -45 // Rotate tick labels
                    },
                    yaxis: {
                        range: yRange,
                        showgrid: true, // Show grid lines
                        zeroline: true, // Show y-axis
                        zerolinewidth: 2, // Width of the y-axis
                        side: 'right', // Position y-axis on the right
                        overlaying: 'free', // Ensure the y-axis is not under anything
                        position: 1.00 // Move the y-axis further to the right
                    },
                    margin: {
                        t: 60, // Increase top margin for title
                        r: 60, // Adjust right margin for better y-axis visibility
                        b: 60, // Add margin to the bottom to avoid overcrowding
                        l: 0 // Remove left margin to integrate with tabs
                    },
                    dragmode: 'pan', // Enable pan mode
                    hovermode: 'x unified', // Enable unified hover mode
                    showlegend: false // Disable legend
                };

                Plotly.newPlot('plot-container', plotData, layout);

                const plotDiv = document.getElementById('plot-container');

            })
            .catch(error => {
                console.error('Error fetching JSON data:', error);
            });
        }

        function showTimeframe(timeframe) {
            currentTimeframe = timeframe;
            console.log("Switching timeframe to: " + timeframe);
            document.querySelectorAll('.bottom-button-container button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.bottom-button-container button[onclick="showTimeframe('${timeframe}')"]`).classList.add('active');
            fetchAndRenderPlotlyChart(selectedYears, currentTimeframe);
        }

        function handleTabClick(year) {
            selectedYears = [year];
            console.log("Selected years: " + selectedYears);
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="handleTabClick('${year}')"]`).classList.add('active');
            fetchAndRenderPlotlyChart(selectedYears, currentTimeframe);
        }

        function handleRightClick(event, year) {
            event.preventDefault(); // Prevent the default context menu
            console.log("Right-clicked on tab: " + year);
            if (selectedYears.includes(year)) {
                selectedYears = selectedYears.filter(y => y !== year);
                document.querySelector(`.tab[onclick="handleTabClick('${year}')"]`).classList.remove('active');
            } else {
                addTab(year);
            }
            fetchAndRenderPlotlyChart(selectedYears, currentTimeframe);
        }

        function addTab(year) {
            if (!selectedYears.includes(year)) {
                selectedYears.push(year);
                document.querySelector(`.tab[onclick="handleTabClick('${year}')"]`).classList.add('active');
                fetchAndRenderPlotlyChart(selectedYears, currentTimeframe);
            }
        }

        window.onload = function() {
            console.log("Window loaded");
            handleTabClick('2014');
        }

        // Resize Plotly chart when window is resized
        window.onresize = function() {
            Plotly.Plots.resize(document.getElementById('plot-container'));
        }
    </script>
</body>
</html>
